<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>STA — Store Locator</title>
  <style>
  *{ box-sizing:border-box; }
  html,body{ margin:0; padding:0; }
  body{
    background:#fdfcf9;
    color:#111;
    font:16px/1.5 system-ui,-apple-system,"Segoe UI",Inter,Roboto,Arial,sans-serif;
  }
</style>


  <script src="./checkout.js" defer></script>
</head>
<body>

<div id="sta-nav"></div>
<script>
  fetch('./sta-header.html')
    .then(r => r.text())
    .then(html => document.getElementById('sta-nav').innerHTML = html);
</script>

  <div id="staSnipcartMount"></div>
<section class="sta-map" aria-label="STA Locations">
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <style>
    .sta-map{
      --ink:#111; --dim:#5b606b; --accent:#c71f2d; --bg:#F7F5F3; --panel:#fff; --line:#e9e9e9;
      --shadow:0 8px 24px rgba(0,0,0,.06); --radius:16px;
      font:14px/1.5 system-ui,-apple-system,"Segoe UI",Inter,Roboto,Arial,sans-serif;
      color:var(--ink); background:var(--bg);
    }
    .sta-map .wrap{
      max-width:1200px; margin:clamp(12px,3vw,28px) auto; padding:0 clamp(12px,3vw,20px);
    }
    .sta-map .grid{
      display:grid; gap:16px; grid-template-columns: 360px 1fr;
    }
    @media (max-width:900px){ .sta-map .grid{ grid-template-columns:1fr; } }
    .sta-card{
      background:var(--panel); border:1px solid var(--line); border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .sta-list{ padding:14px; max-height:560px; overflow:auto; }
    .sta-item{
      border-bottom:1px dashed var(--line); padding:10px 2px; cursor:pointer;
    }
    .sta-item:last-child{ border-bottom:none; }
    .sta-name{ font-weight:700; }
    .sta-meta{ color:var(--dim); font-size:13px; margin-top:4px; }
    .sta-link{
      display:inline-block; margin-top:6px; font-weight:600; color:var(--accent); text-decoration:none;
    }
    .legend{
      display:flex; gap:8px; align-items:center; padding:10px 14px; border-bottom:1px solid var(--line);
      background:linear-gradient(0deg,#ffffff,#fff7f7);
      border-top-left-radius:var(--radius); border-top-right-radius:var(--radius);
      font-weight:600;
    }
    .dot{ width:10px; height:10px; background:var(--accent); border-radius:50%; box-shadow:0 0 0 3px #ffdfe2 inset; }
    #map{ height:600px; border-radius:var(--radius); border:1px solid var(--line); }
    .no-pin{
      margin-top:10px; padding-top:10px; border-top:1px solid var(--line); color:var(--dim); font-size:13px;
    }
  </style>

  <div class="wrap">
    <div class="grid">
      <aside class="sta-card">
        <div class="legend"><span class="dot"></span> STA Locations</div>
        <div class="sta-list" id="staList"></div>
      </aside>
      <div id="map" class="sta-card"></div>
    </div>
  </div>

  <script>
    // Pre-set coordinates (Manhattan area, approximated for instant load)
    const LOCATIONS = [
      { name:'Flower Power', contacts:"", address:'22 W 66th St, New York, NY 10023', lat:null, lon:null, notes:"" },
      { name:'Travel Agency Brooklyn', contacts:"", address:'122 Flatbush Ave, Brooklyn, NY 11217', lat:null, lon:null, notes:"" },
      { name:'Happy Munkey', contacts:"", address:'151 Dyckman St, New York, NY 10034', lat:null, lon:null, notes:"" },
      { name:'Emerald Bushwick', contacts:"", address:'85 Suydam St, Brooklyn, NY 11221', lat:null, lon:null, notes:"" },
      { name:'Emerald Upper East Side', contacts:"", address:'1190 Lexington Ave, New York, NY 10028', lat:null, lon:null, notes:"" },
      { name:'Flower City Rochester', contacts:"", address:'8053 Pittsford Palmyra Rd, Victor, NY 14564', lat:null, lon:null, notes:"" },
      { name:'BK Exotics', contacts:"", address:'1056 Flatbush Ave, Brooklyn, NY 11226', lat:null, lon:null, notes:"" },
      { name:'Sky High Club', contacts:"", address:'129 Avenue C, New York, NY 10009', lat:null, lon:null, notes:"" },
      { name:'House Of Strains', contacts:"", address:'161-05 29th Ave, Flushing, NY 11358', lat:null, lon:null, notes:"" },
      { name:'HKCC (Hell’s Kitchen Cannabis Club)', contacts:"", address:'356 W 40th St, New York, NY 10018', lat:null, lon:null, notes:"" },
      { name:'My Bud 420 Bronx', contacts:"", address:'1798 E Tremont Ave, Bronx, NY 10460', lat:null, lon:null, notes:"" },
      { name:'The Flowery Soho', contacts:"", address:'481 Broadway, New York, NY 10013', lat:null, lon:null, notes:"" },
      { name:'Munchies Rockaway Beach', contacts:"", address:'87-01 Rockaway Beach Blvd, Far Rockaway, NY 11693', lat:null, lon:null, notes:"" },
      { name:'Urban Weeds Astoria', contacts:"", address:'31-35 Steinway St, Astoria, NY 11103', lat:null, lon:null, notes:"" },
      { name:'Misha Flower Shop', contacts:"", address:'299 Knickerbocker Ave, Brooklyn, NY 11237', lat:null, lon:null, notes:"" },
      { name:'Goodlife Rochester', contacts:"", address:'155 Monroe Ave, Rochester, NY 14607', lat:null, lon:null, notes:"" },
      { name:'Goodlife Buffalo', contacts:"", address:'577 Forest Ave, Buffalo, NY 14222', lat:null, lon:null, notes:"" },
      { name:'The Spot Brooklyn', contacts:"", address:'154 Vanderbilt Ave, Brooklyn, NY 11205', lat:null, lon:null, notes:"" },
      { name:'The Flowery Staten Island South Shore', contacts:"", address:'3022 Veterans Rd W, Staten Island, NY 10309', lat:null, lon:null, notes:"" },
      { name:'The Flowery Staten Island Richmond Avenue', contacts:"", address:'2059 Richmond Ave, Staten Island, NY 10314', lat:null, lon:null, notes:"" },
      { name:'Nucleus Manhattan', contacts:"", address:'1819 2nd Ave, New York, NY 10128', lat:null, lon:null, notes:"" },
      { name:'QUBE Manhattan', contacts:"", address:'1412 Broadway, New York, NY 10018', lat:null, lon:null, notes:"" },
      { name:'Culture House NYC', contacts:"", address:'958 6th Ave, New York, NY 10001', lat:null, lon:null, notes:"" },
      { name:'Pryzm', contacts:"", address:'15 Avenue B, New York, NY 10009', lat:null, lon:null, notes:"" },
      { name:'Planet Nug Farmingdale', contacts:"", address:'2043 Wellwood Ave, Farmingdale, NY 11735', lat:null, lon:null, notes:"" },
      { name:'Flower Power Maspeth', contacts:"", address:'71-10 Grand Ave, Maspeth, NY 11378', lat:null, lon:null, notes:"" },
      { name:'The Flowery Queens', contacts:"", address:'63-54 108th St, Forest Hills, NY 11375', lat:null, lon:null, notes:"" },
      { name:'Seaweed Far Rockaway', contacts:"", address:'73-13 Beach Channel Dr, Arverne, NY 11692', lat:null, lon:null, notes:"" },
      { name:'Kush Klub', contacts:"", address:'186 Orchard St, New York, NY 10002', lat:null, lon:null, notes:"" },
      { name:'Highstone', contacts:"", address:'1938 Clove Rd, Staten Island, NY 10304', lat:null, lon:null, notes:"" },
      { name:'Cannadreams', contacts:"", address:'862 9th Ave, New York, NY 10019', lat:null, lon:null, notes:"" }
    ];

    const map = L.map('map', { scrollWheelZoom: true }).setView([40.75,-73.98], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom:19, attribution:'&copy; OpenStreetMap'
    }).addTo(map);

    const listEl = document.getElementById('staList');
    const group = L.featureGroup().addTo(map);
    const pending = [];

    const googleMapsLink = (addr)=>`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;

    // --- Lightweight geocoding (adds pins automatically) ---
    // Uses OpenStreetMap Nominatim in the browser + localStorage cache.
    const GEO_CACHE_KEY = 'sta_geo_cache_v1';
    let geoCache = {};
    try { geoCache = JSON.parse(localStorage.getItem(GEO_CACHE_KEY) || '{}'); } catch(e){ geoCache = {}; }
    const saveGeoCache = ()=>{ try{ localStorage.setItem(GEO_CACHE_KEY, JSON.stringify(geoCache)); } catch(e){} };

    const sleep = (ms)=>new Promise(r=>setTimeout(r, ms));

    async function geocodeAddress(addr){
      if(!addr) return null;
      if(geoCache[addr]) return geoCache[addr];

      const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(addr)}`;
      const res = await fetch(url, { headers: { 'Accept':'application/json' } }).catch(()=>null);
      if(!res || !res.ok) return null;

      const data = await res.json().catch(()=>null);
      if(data && data[0] && data[0].lat && data[0].lon){
        const out = { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) };
        geoCache[addr] = out;
        saveGeoCache();
        return out;
      }
      return null;
    }

    function buildPopup(loc){
      const addr = loc.address || 'No public address';
      return `
        <strong>${loc.name}</strong><br/>
        ${addr}<br/>
        ${loc.notes ? `<em>${loc.notes}</em><br/>` : ''}
        ${loc.address ? `<a href="${googleMapsLink(loc.address)}" target="_blank">Open in Maps</a>` : ''}
      `;
    }

    function addMarker(loc){
      if(!(loc.lat && loc.lon)) return;
      const marker = L.marker([loc.lat, loc.lon]).addTo(group).bindPopup(buildPopup(loc));
      loc._marker = marker;
    }

    LOCATIONS.forEach(loc=>{
      const addr = loc.address || 'No public address';
      const item = document.createElement('div');
      item.className='sta-item';
      item.innerHTML = `
        <div class="sta-name">${loc.name}</div>
        <div class="sta-meta">${loc.contacts ? loc.contacts : ''}</div>
        <div class="sta-meta">${addr}</div>
        ${loc.address ? `<a class="sta-link" href="${googleMapsLink(loc.address)}" target="_blank">Open in Maps →</a>` : ''}
      `;
      listEl.appendChild(item);

      // store for later + click behavior
      loc._itemEl = item;

      item.addEventListener('click', ()=>{
        if(loc._marker){
          map.flyTo([loc.lat, loc.lon], 16, { duration: 0.6 });
          loc._marker.openPopup();
        } else if(loc.address){
          window.open(googleMapsLink(loc.address), '_blank');
        }
      });

      if(loc.lat && loc.lon){
        addMarker(loc);
      } else if(loc.address){
        pending.push(loc);
      }
    });

    if(group.getLayers().length){ map.fitBounds(group.getBounds().pad(0.12)); }

    // Note: pins may take a moment to load on first visit.
    if(pending.length){
      const div=document.createElement('div');
      div.className='no-pin';
      div.innerHTML=`<strong>Loading pins…</strong> If you don’t see pins right away, give it a few seconds.`;
      listEl.appendChild(div);
    }

    (async function resolvePins(){
      for(const loc of pending){
        const coords = await geocodeAddress(loc.address);
        if(coords){
          loc.lat = coords.lat;
          loc.lon = coords.lon;
          addMarker(loc);
        }
        // be polite to the free geocoder
        await sleep(1100);
      }
      if(group.getLayers().length){ map.fitBounds(group.getBounds().pad(0.12)); }
    })();
  </script>
</section>



</body>
</html>
