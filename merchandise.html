<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STA Merchandise</title>

  <!-- keep your existing checkout helper if you have one -->
  <script src="./checkout.js" defer></script>

  <style>
    :root{
      --ink:#0f0f0f; --dim:#666b74; --accent:#c71f2d;
      --bg:#f7f5f3; --panel:#fff; --line:#e7e7e7;
      --shadow:0 14px 40px rgba(0,0,0,.10);
      --r:18px;
      --max:1100px;
      --g:clamp(14px,3vw,22px);
    }

    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; }
    body{
      font:16px/1.5 system-ui,-apple-system,"Segoe UI",Inter,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 10% 0%, rgba(199,31,45,.10), transparent 60%),
        radial-gradient(900px 520px at 90% 0%, rgba(199,31,45,.06), transparent 55%),
        var(--bg);
    }
    a{ color:inherit; text-decoration:none; }
    main{ max-width:var(--max); margin:0 auto; padding:22px var(--g) 70px; }

    /* ===== Product layout ===== */
    .wrap{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      min-height:560px;
    }
    @media (max-width: 920px){ .wrap{ grid-template-columns:1fr; } }

    .media{
      background:#0b0b0b;
      position:relative;
      min-height:420px;
    }
    .media img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .fallback{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:22px;
      color:#fff;
      text-align:center;
      background:linear-gradient(135deg,#151515,#070707);
    }
    .fallback b{ display:block; font-size:18px; margin-bottom:8px; }
    .fallback span{ opacity:.85; font-weight:650; font-size:13px; }

    .panel{ padding:22px 22px 26px; }
    h1{ margin:0 0 8px; font-size:26px; letter-spacing:-.03em; font-weight:1000; }
    .muted{ margin:0 0 14px; color:var(--dim); font-weight:650; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:14px 0 16px; }
    label{ font-size:13px; color:var(--dim); font-weight:850; }
    select{
      height:40px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:950;
      width:110px;
    }

    .btn{
      width:100%;
      height:46px;
      border-radius:14px;
      border:1px solid #dcdcdc;
      background:#fff;
      font-weight:1000;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition:transform .08s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
    }
    .btn:hover{ background:#f7f7f7; }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .btn.primary:hover{ background:#a81823; border-color:#a81823; }
    .btn.stripe::before{
      content:"";
      width:18px; height:18px;
      border-radius:6px;
      background:linear-gradient(135deg,#635bff,#00d4ff);
      box-shadow:0 10px 22px rgba(99,91,255,.22);
      display:inline-block;
    }
    .btn + .btn{ margin-top:10px; }
    .btn:disabled{ opacity:.65; cursor:not-allowed; }

    .back{
      display:inline-block;
      margin-top:14px;
      font-weight:1000;
      color:#121212;
    }

    /* ===== Header injection host ===== */
    #sta-nav{ width:100%; }

    /* ===== Make injected STA header SHORT + consistent (NO CLIPPING) =====
       Your issue was wrapping + extra padding, then you tried max-height/overflow hidden which killed nav/items.
       This fixes height without hiding anything.
    */
    #sta-nav .sta-banner{ position:sticky !important; top:0 !important; z-index:100 !important; }

    #sta-nav .sta-banner .wrap{
      max-width:var(--max) !important;
      padding:10px var(--g) !important;   /* shorter */
      gap:10px !important;
      flex-wrap:nowrap !important;        /* prevents tall wrap */
      align-items:center !important;
    }

    #sta-nav .sta-brand{ white-space:nowrap !important; }
    #sta-nav .sta-brand .sub{ display:none !important; } /* keeps header compact */

    #sta-nav .sta-actions{
      flex-wrap:nowrap !important;
      overflow-x:auto !important;
      -webkit-overflow-scrolling:touch;
      scrollbar-width:none;
    }
    #sta-nav .sta-actions::-webkit-scrollbar{ display:none; }

    #sta-nav .sta-chip{
      padding:7px 10px !important;        /* slightly smaller pills */
      font-weight:850 !important;
    }

    #sta-nav .sta-right{
      flex-wrap:nowrap !important;
      gap:8px !important;
      margin-left:auto !important;
      align-items:center !important;
    }

    /* On very small screens, let it wrap once, but still stay tight */
    @media (max-width: 520px){
      #sta-nav .sta-banner .wrap{ flex-wrap:wrap !important; }
      #sta-nav .sta-right{ width:100% !important; justify-content:space-between !important; }
    }

    /* ===== Toast ===== */
    .sta-toast{
      position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
      background:#0f0f0f; color:#fff; padding:10px 14px; border-radius:12px;
      font-weight:900; z-index:9999; box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
  </style>
</head>

<body>
  <!-- Injected header lives here -->
  <div id="sta-nav" aria-label="Site navigation"></div>

  <main>
    <section class="wrap" aria-label="Merch item">
      <div class="media">
        <img id="p-img" src="" alt="">
        <div id="p-fallback" class="fallback" style="display:none;">
          <div>
            <b>Image not loading</b>
            <span>This usually means the image URL is wrong or blocked.</span>
          </div>
        </div>
      </div>

      <div class="panel">
        <h1 id="p-title">Merch</h1>
        <p id="p-desc" class="muted">STA merchandise.</p>

        <div class="row">
          <label for="qty">Qty</label>
          <select id="qty">
            <option>1</option><option>2</option><option>3</option><option>4</option>
          </select>
        </div>

        <button id="buyNow" class="btn primary stripe" data-stripe-checkout data-price-id="">
          Continue with Stripe
        </button>

        <button id="addToCart" class="btn" type="button">
          Add to Cart
        </button>

        <a class="back" href="./merch.html">‚Üê Back to merch</a>
      </div>
    </section>
  </main>

  <script>
    /* =============================
       1) Inject sta-header.html
       ============================= */
    (async function injectHeader(){
      const host = document.getElementById('sta-nav');
      try{
        const res = await fetch('./sta-header.html', { cache:'no-store' });
        if(!res.ok) throw new Error('sta-header.html not found');
        host.innerHTML = await res.text();
      }catch(e){
        // Minimal fallback (still includes a cart button + badge)
        host.innerHTML = `
          <div style="background:#0f0f0f;color:#fff;border-bottom:1px solid #222;">
            <div style="max-width:${getComputedStyle(document.documentElement).getPropertyValue('--max')||'1100px'};margin:0 auto;padding:10px ${getComputedStyle(document.documentElement).getPropertyValue('--g')||'16px'};display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
              <div style="font-weight:1000;letter-spacing:.08em;">STA</div>
              <div style="display:flex;gap:12px;flex-wrap:wrap;font-weight:850;">
                <a href="./index.html" style="color:#fff;opacity:.9;">Home</a>
                <a href="./products.html" style="color:#fff;opacity:.9;">Products</a>
                <a href="./merch.html" style="color:#fff;opacity:1;text-decoration:underline;text-underline-offset:4px;">Merch</a>
              </div>
              <button id="sta-cart-btn" type="button" style="background:#fff;color:#0f0f0f;border:none;border-radius:999px;padding:6px 12px;font-weight:950;cursor:pointer;">
                üõí <span id="sta-cart-count" style="background:#c71f2d;color:#fff;border-radius:999px;padding:2px 6px;font-size:11px;">0</span>
              </button>
            </div>
          </div>

          <div id="sta-cart-modal" class="sta-cartmodal" aria-hidden="true" role="dialog" aria-label="Shopping cart">
            <div class="sta-cartpanel" role="document">
              <div class="sta-carthead">
                <div class="sta-carttitle">Your Cart</div>
                <button type="button" class="sta-x" data-cart-close aria-label="Close cart">‚úï</button>
              </div>
              <div id="sta-cart-list" class="sta-cartlist"></div>
              <div class="sta-cartfoot">
                <button type="button" class="sta-cartbtn" id="sta-cart-clear">Clear</button>
                <button type="button" class="sta-cartbtn primary" id="sta-cart-checkout">Checkout</button>
              </div>
            </div>
          </div>
        `;
      } finally {
        // once header exists, sync badge + bind cart UI
        STA_CART.refreshBadge();
      }
    })();

    /* =============================
       2) Product data + populate
       ============================= */
    const PRODUCTS = {
      "sta-hoodie": {
        id: "sta-hoodie",
        name: "STA Signature Hoodie ‚Äî Heavyweight",
        desc: "Heavyweight hoodie with STA print. Clean fit, built to last.",
        priceId: "price_1ShgiV1blBzCNuBQL9FtDioU",
        img: "https://images.squarespace-cdn.com/content/v1/68e0528f4cec933d5b272876/1f4bb64e-5bed-44b7-9d6d-afb4616c7bdb/126B40DF-C0AA-4299-BBFF-CC4ACC51125D.png?format=1500w"
      },
      "sta-tee": {
        id: "sta-tee",
        name: "STA Classic Tee ‚Äî Ringspun Cotton",
        desc: "Soft ringspun cotton tee with STA graphic. Everyday staple.",
        priceId: "price_1ShgiV1blBzCNuBQL9FtDioU",
        img: "https://images.squarespace-cdn.com/content/v1/68e0528f4cec933d5b272876/05af804f-6d7e-4f69-91f7-98b4fafa15f3/2STA_Art_Front_PrintReady.png?format=1500w"
      }
    };

    function qs(name){ return new URLSearchParams(location.search).get(name); }

    const PAGE = {
      currentItemKey: null,
      currentProduct: null,
      getQty(){
        return Math.max(1, parseInt(document.getElementById('qty')?.value || '1', 10) || 1);
      }
    };

    (function populate(){
      const itemKey = qs('item') || 'sta-hoodie';
      const p = PRODUCTS[itemKey] || PRODUCTS['sta-hoodie'];

      PAGE.currentItemKey = itemKey;
      PAGE.currentProduct = p;

      const titleEl = document.getElementById('p-title');
      const descEl  = document.getElementById('p-desc');
      const imgEl   = document.getElementById('p-img');
      const fbEl    = document.getElementById('p-fallback');
      const buyBtn  = document.getElementById('buyNow');

      titleEl.textContent = p.name;
      descEl.textContent  = p.desc;

      buyBtn.setAttribute('data-price-id', p.priceId || '');

      const src = qs('img') || p.img || '';
      imgEl.alt = p.name;

      if (!src){
        imgEl.style.display = 'none';
        fbEl.style.display = 'flex';
      } else {
        imgEl.src = src;
        imgEl.onload = () => { fbEl.style.display = 'none'; imgEl.style.display = 'block'; };
        imgEl.onerror = () => { imgEl.style.display = 'none'; fbEl.style.display = 'flex'; };
      }
    })();

    /* =============================
       3) Cart (localStorage) + UI
       - Updates #sta-cart-count (in injected header)
       - Renders modal list (in injected header)
       - Checkout uses Stripe /api/create-checkout-session
       ============================= */
    const STA_CART = (function(){
      const CART_KEY = 'sta_cart';

      function read(){
        try { return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); }
        catch { return []; }
      }
      function write(cart){
        localStorage.setItem(CART_KEY, JSON.stringify(cart));
      }

      function normalize(x){
        const img = x.img || x.image || x.imageUrl || '';
        return {
          id: String(x.id || ''),
          name: String(x.name || 'STA Item'),
          img: String(img || ''),
          qty: Math.max(1, parseInt(x.qty || 1, 10) || 1),
          priceId: String(x.priceId || x.price_id || '')
        };
      }

      function count(cart){
        return cart.reduce((sum, it) => sum + (it.qty || 0), 0);
      }

      function badgeEl(){
        return document.getElementById('sta-cart-count'); // from sta-header.html
      }

      function refreshBadge(){
        const cart = read().map(normalize);
        const el = badgeEl();
        if (el) el.textContent = String(count(cart));
      }

      function toast(msg){
        const t = document.createElement('div');
        t.className = 'sta-toast';
        t.textContent = msg;
        document.body.appendChild(t);
        setTimeout(()=> t.remove(), 1400);
      }

      function modal(){
        return document.getElementById('sta-cart-modal');
      }
      function listEl(){
        return document.getElementById('sta-cart-list');
      }

      function open(){
        const m = modal();
        if (!m) return;
        render();
        m.setAttribute('aria-hidden','false');
        document.body.style.overflow = 'hidden';
      }
      function close(){
        const m = modal();
        if (!m) return;
        m.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
      }

      function render(){
        const list = listEl();
        if (!list) { refreshBadge(); return; }

        let cart = read().map(normalize);
        write(cart); // store normalized
        refreshBadge();

        if (!cart.length){
          list.innerHTML = `<div style="padding:14px;color:#5b606b;font-weight:750;">Your cart is empty.</div>`;
          return;
        }

        list.innerHTML = cart.map((it) => {
          const safeName = escapeHtml(it.name);
          const safeImg = it.img || '';
          return `
            <div class="sta-cartrow" data-id="${encodeURIComponent(it.id)}">
              <img src="${safeImg}" alt="${safeName}" onerror="this.style.display='none'">
              <div class="sta-cartmeta">
                <div class="sta-cartname">${safeName}</div>
                <div class="sta-cartsub">${escapeHtml(it.priceId ? '' : '')}</div>
              </div>
              <div class="sta-cartqty">
                <button class="sta-qbtn" type="button" data-qty="-1" aria-label="Decrease quantity">‚àí</button>
                <div class="sta-qnum">${it.qty}</div>
                <button class="sta-qbtn" type="button" data-qty="+1" aria-label="Increase quantity">+</button>
              </div>
            </div>
          `;
        }).join('');
      }

      function escapeHtml(s){
        return String(s)
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;")
          .replaceAll("'","&#039;");
      }

      function add(item){
        const cart = read().map(normalize);
        const n = normalize(item);
        if (!n.id) return;

        const existing = cart.find(x => x.id === n.id);
        if (existing) {
          existing.qty += n.qty;
          // keep priceId/img/name up to date
          existing.priceId = n.priceId || existing.priceId;
          existing.img = n.img || existing.img;
          existing.name = n.name || existing.name;
        } else {
          cart.push(n);
        }

        write(cart);
        refreshBadge();
        toast(`Added to cart (${n.qty})`);
      }

      function setQty(id, delta){
        const cart = read().map(normalize);
        const it = cart.find(x => x.id === id);
        if (!it) return;
        it.qty = Math.max(1, it.qty + delta);
        write(cart);
        render();
      }

      function clear(){
        write([]);
        render();
      }

      async function checkout(){
        const cart = read().map(normalize).filter(x => x.priceId && x.qty > 0);

        if (!cart.length){
          toast('Cart is empty');
          return;
        }

        // Stripe expects: { items: [{ priceId, quantity }] }
        const payload = {
          items: cart.map(x => ({ priceId: x.priceId, quantity: x.qty }))
        };

        const btn = document.getElementById('sta-cart-checkout');
        if (btn) { btn.disabled = true; btn.setAttribute('aria-busy','true'); }

        try{
          const r = await fetch('/api/create-checkout-session', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify(payload)
          });

          const data = await r.json().catch(()=> ({}));
          const url = data.url || data.checkoutUrl || data.checkout_url;
          if (!r.ok || !url) throw new Error(data.error || ('Checkout failed (' + r.status + ')'));
          window.location.href = url;
        }catch(err){
          console.error(err);
          alert(err?.message || 'Stripe checkout failed');
        }finally{
          if (btn) { btn.disabled = false; btn.removeAttribute('aria-busy'); }
        }
      }

      // Event delegation so it works even though header is injected AFTER load
      document.addEventListener('click', (e) => {
        // Open cart
        if (e.target.closest('#sta-cart-btn')) {
          e.preventDefault();
          open();
          return;
        }

        // Close cart
        if (e.target.closest('[data-cart-close]')) {
          e.preventDefault();
          close();
          return;
        }

        // Backdrop close
        const m = modal();
        if (m && e.target === m){
          close();
          return;
        }

        // Qty buttons
        const qbtn = e.target.closest('.sta-cartrow [data-qty]');
        if (qbtn) {
          const row = e.target.closest('.sta-cartrow');
          const id = row ? decodeURIComponent(row.getAttribute('data-id') || '') : '';
          const delta = qbtn.getAttribute('data-qty') === '+1' ? 1 : -1;
          setQty(id, delta);
          return;
        }

        // Clear
        if (e.target.closest('#sta-cart-clear')) {
          e.preventDefault();
          clear();
          return;
        }

        // Checkout
        if (e.target.closest('#sta-cart-checkout')) {
          e.preventDefault();
          checkout();
          return;
        }
      });

      // Keep badge in sync if updated elsewhere
      window.addEventListener('storage', (ev) => {
        if (ev.key === CART_KEY) refreshBadge();
      });

      return { add, read, refreshBadge, open, close, render, checkout };
    })();

    /* =============================
       4) Add-to-cart + Buy-now (Stripe)
       ============================= */
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('#addToCart');
      if (!btn) return;

      const p = PAGE.currentProduct;
      if (!p) return;

      const qty = PAGE.getQty();

      // IMPORTANT: store priceId so cart checkout works
      STA_CART.add({
        id: p.id,
        name: p.name,
        img: document.getElementById('p-img')?.getAttribute('src') || p.img || '',
        qty,
        priceId: p.priceId
      });
    }, true);

    async function goStripeCheckoutSingle(priceId, quantity) {
      const r = await fetch('/api/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ items: [{ priceId, quantity }] })
      });
      const data = await r.json().catch(()=> ({}));
      const url = data.url || data.checkoutUrl || data.checkout_url;
      if (!r.ok || !url) throw new Error(data.error || ('Checkout failed ('+r.status+')'));
      window.location.href = url;
    }

    // Buy now button (single item)
    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-stripe-checkout]');
      if (!btn) return;

      e.preventDefault();
      e.stopImmediatePropagation();

      const priceId = btn.getAttribute('data-price-id') || '';
      if (!priceId) { alert('Missing Stripe price id.'); return; }

      try{
        btn.disabled = true;
        btn.setAttribute('aria-busy','true');
        await goStripeCheckoutSingle(priceId, PAGE.getQty());
      }catch(err){
        console.error(err);
        alert(err?.message || 'Stripe checkout failed');
      }finally{
        btn.disabled = false;
        btn.removeAttribute('aria-busy');
      }
    }, true);

    // Initial badge sync (will re-run after injection too)
    document.addEventListener('DOMContentLoaded', () => {
      STA_CART.refreshBadge();
    });
  </script>
</body>
</html>
