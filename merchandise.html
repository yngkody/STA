<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>STA Merchandise</title>

  <!-- keep if you already use it elsewhere -->
  <script src="./checkout.js" defer></script>

  <style>
    :root{
      --ink:#0f0f0f;
      --dim:#666b74;
      --accent:#c71f2d;
      --bg:#f7f5f3;
      --panel:#fff;
      --line:#e7e7e7;
      --shadow:0 14px 40px rgba(0,0,0,.10);
      --r:18px;

      /* set this to match the rest of your site width */
      --max:1180px;
      --g:clamp(14px,3vw,22px);
    }

    *{ box-sizing:border-box; }
    html,body{ margin:0; padding:0; }

    body{
      font:16px/1.5 system-ui,-apple-system,"Segoe UI",Inter,Roboto,Arial,sans-serif;
      color:var(--ink);
      background:
        radial-gradient(900px 520px at 10% 0%, rgba(199,31,45,.10), transparent 60%),
        radial-gradient(900px 520px at 90% 0%, rgba(199,31,45,.06), transparent 55%),
        var(--bg);
    }

    a{ color:inherit; text-decoration:none; }
    img{ display:block; max-width:100%; }

    /* ===== HEADER CONTAINER (CENTER IT, DON’T CLIP IT) ===== */
    #sta-nav{
      width:100%;
      display:flex;
      justify-content:center;
    }
    #sta-nav > *{
      width:100%;
      max-width:var(--max);
      padding:0 var(--g);
    }

    /* Cart badge that we can inject onto whatever cart element exists */
    .sta-cart-wrap{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .sta-cart-badge{
      position:absolute;
      top:-6px;
      right:-6px;
      min-width:18px;
      height:18px;
      padding:0 5px;
      border-radius:999px;
      background:var(--accent);
      color:#fff;
      font-size:11px;
      font-weight:900;
      line-height:18px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 10px 18px rgba(199,31,45,.25);
      pointer-events:none;
    }

    /* ===== PAGE ===== */
    main{
      max-width:var(--max);
      margin:0 auto;
      padding:18px var(--g) 70px;
    }

    .wrap{
      background:var(--panel);
      border:1px solid var(--line);
      border-radius:var(--r);
      box-shadow:var(--shadow);
      overflow:hidden;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      min-height:560px;
    }
    @media (max-width: 920px){
      .wrap{ grid-template-columns:1fr; }
    }

    .media{
      background:#0b0b0b;
      position:relative;
      min-height:420px;
    }
    .media img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .fallback{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:22px;
      color:#fff;
      text-align:center;
      background:linear-gradient(135deg,#151515,#070707);
    }
    .fallback b{ display:block; font-size:18px; margin-bottom:8px; }
    .fallback span{ opacity:.85; font-weight:650; font-size:13px; }

    .panel{ padding:22px 22px 26px; }
    h1{ margin:0 0 8px; font-size:26px; letter-spacing:-.03em; font-weight:1000; }
    .muted{ margin:0 0 14px; color:var(--dim); font-weight:650; }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:14px 0 16px; }
    label{ font-size:13px; color:var(--dim); font-weight:850; }

    select{
      height:40px;
      padding:0 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:950;
      width:110px;
    }

    .btn{
      width:100%;
      height:46px;
      border-radius:14px;
      border:1px solid #dcdcdc;
      background:#fff;
      font-weight:1000;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      transition:transform .08s ease, background .15s ease, border-color .15s ease, opacity .15s ease;
      user-select:none;
    }
    .btn:hover{ background:#f7f7f7; }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .btn.primary:hover{ background:#a81823; border-color:#a81823; }

    .btn.stripe::before{
      content:"";
      width:18px; height:18px;
      border-radius:6px;
      background:linear-gradient(135deg,#635bff,#00d4ff);
      box-shadow:0 10px 22px rgba(99,91,255,.22);
      display:inline-block;
    }

    .btn + .btn{ margin-top:10px; }
    .btn:disabled{ opacity:.65; cursor:not-allowed; }

    .back{
      display:inline-block;
      margin-top:14px;
      font-weight:1000;
      color:#121212;
    }
    .note{
      margin-top:10px;
      color:var(--dim);
      font-size:13px;
      font-weight:650;
    }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
      background:#0f0f0f; color:#fff; padding:10px 14px; border-radius:12px;
      font-weight:900; z-index:9999; box-shadow:0 10px 30px rgba(0,0,0,.25);
      opacity:0; pointer-events:none;
      transition:opacity .2s ease;
      max-width:calc(100vw - 28px);
      text-align:center;
    }
    .toast.show{ opacity:1; }
  </style>
</head>

<body>
  <div id="sta-nav" aria-label="Site navigation"></div>

  <main>
    <section class="wrap" aria-label="Merch item">
      <div class="media">
        <img id="p-img" src="" alt="">
        <div id="p-fallback" class="fallback" style="display:none;">
          <div>
            <b>Image not loading</b>
            <span>This usually means the image URL is wrong or blocked.</span>
          </div>
        </div>
      </div>

      <div class="panel">
        <h1 id="p-title">Merch</h1>
        <p id="p-desc" class="muted">STA merchandise.</p>

        <div class="row">
          <label for="qty">Qty</label>
          <select id="qty">
            <option>1</option><option>2</option><option>3</option><option>4</option>
          </select>
        </div>

        <!-- Stripe -->
        <button id="buyNow" class="btn primary stripe" type="button" data-stripe-checkout data-price-id="">
          Continue with Stripe
        </button>

        <!-- Add to cart -->
        <button id="addToCart" class="btn" type="button">
          Add to Cart
        </button>

        <a class="back" href="./merch.html">← Back to merch</a>
        <div class="note">Cart count updates in the header automatically.</div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    /* =========================
       NAV INJECT (use your real header)
       ========================= */
    async function injectHeader(){
      const host = document.getElementById('sta-nav');
      try{
        const res = await fetch('./sta-header.html', { cache:'no-store' });
        if(!res.ok) throw new Error('sta-header.html not found');
        const html = await res.text();
        if(!html || html.trim().length < 40) throw new Error('sta-header.html empty');
        host.innerHTML = html;

        // After header loads, ensure we have a badge to update
        ensureCartBadge();
        updateCartBadge(getCartCount());
      }catch(e){
        // If header file is missing, fail loud but still usable
        host.innerHTML = `<div style="max-width:var(--max);margin:0 auto;padding:14px var(--g);color:var(--dim);font-weight:900;">
          Missing sta-header.html (nav).
        </div>`;
      }
    }

    /* =========================
       PRODUCT DATA + POPULATE
       ========================= */
    const PRODUCTS = {
      "sta-hoodie": {
        name: "STA Signature Hoodie — Heavyweight",
        desc: "Heavyweight hoodie with STA print. Clean fit, built to last.",
        priceId: "price_1ShgiV1blBzCNuBQL9FtDioU",
        img: "https://images.squarespace-cdn.com/content/v1/68e0528f4cec933d5b272876/1f4bb64e-5bed-44b7-9d6d-afb4616c7bdb/126B40DF-C0AA-4299-BBFF-CC4ACC51125D.png?format=1500w"
      },
      "sta-tee": {
        name: "STA Classic Tee — Ringspun Cotton",
        desc: "Soft ringspun cotton tee with STA graphic. Everyday staple.",
        priceId: "price_1ShgiV1blBzCNuBQL9FtDioU",
        img: "https://images.squarespace-cdn.com/content/v1/68e0528f4cec933d5b272876/05af804f-6d7e-4f69-91f7-98b4fafa15f3/2STA_Art_Front_PrintReady.png?format=1500w"
      }
    };

    function qs(name){ return new URLSearchParams(location.search).get(name); }

    function populate(){
      const item = qs('item') || 'sta-hoodie';
      const p = PRODUCTS[item] || PRODUCTS['sta-hoodie'];

      const titleEl = document.getElementById('p-title');
      const descEl  = document.getElementById('p-desc');
      const imgEl   = document.getElementById('p-img');
      const fbEl    = document.getElementById('p-fallback');
      const buyBtn  = document.getElementById('buyNow');

      titleEl.textContent = p.name;
      descEl.textContent  = p.desc;
      buyBtn.setAttribute('data-price-id', p.priceId);

      const src = qs('img') || p.img || '';
      imgEl.alt = p.name;

      if (!src){
        imgEl.style.display = 'none';
        fbEl.style.display = 'flex';
      } else {
        imgEl.src = src;
        imgEl.onload = () => { fbEl.style.display = 'none'; imgEl.style.display = 'block'; };
        imgEl.onerror = () => { imgEl.style.display = 'none'; fbEl.style.display = 'flex'; };
      }
    }

    /* =========================
       CART (localStorage)
       ========================= */
    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> t.classList.remove('show'), 1200);
    }

    function getCart(){
      try { return JSON.parse(localStorage.getItem('sta_cart') || '[]'); }
      catch { return []; }
    }
    function setCart(cart){
      localStorage.setItem('sta_cart', JSON.stringify(cart));
      updateCartBadge(getCartCount());
    }
    function getCartCount(){
      const cart = getCart();
      return cart.reduce((sum, x) => sum + (Number(x.qty) || 0), 0);
    }

    // Find an existing cart element in your real header and guarantee a badge exists
    function ensureCartBadge(){
      // If your header already has a badge we can update, we’re good.
      const existing =
        document.querySelector('[data-cart-count]') ||
        document.querySelector('#cartCount') ||
        document.querySelector('.cart-count') ||
        document.querySelector('.cart-badge') ||
        document.querySelector('.snipcart-items-count');

      if (existing) return;

      // Otherwise: locate a cart link/button and inject our own badge.
      const cartEl =
        document.querySelector('a[href*="cart"]') ||
        document.querySelector('a[aria-label*="cart" i]') ||
        document.querySelector('button[aria-label*="cart" i]') ||
        document.querySelector('.snipcart-checkout') ||
        document.querySelector('.cart') ||
        document.querySelector('.cart-btn');

      if (!cartEl) return;

      // Wrap so badge positions correctly
      if (!cartEl.classList.contains('sta-cart-wrap')) {
        cartEl.classList.add('sta-cart-wrap');
      }

      const badge = document.createElement('span');
      badge.className = 'sta-cart-badge';
      badge.setAttribute('data-cart-count', 'true');
      badge.textContent = '0';
      cartEl.appendChild(badge);
    }

    function updateCartBadge(count){
      const el =
        document.querySelector('[data-cart-count]') ||
        document.querySelector('#cartCount') ||
        document.querySelector('.cart-count') ||
        document.querySelector('.cart-badge') ||
        document.querySelector('.snipcart-items-count');

      if (el) el.textContent = String(count);
    }

    // Add to cart button
    function addToCart(){
      const itemId = qs('item') || 'sta-hoodie';
      const name = document.getElementById('p-title')?.textContent?.trim() || 'STA Item';
      const img  = document.getElementById('p-img')?.getAttribute('src') || '';
      const qty  = Math.max(1, parseInt(document.getElementById('qty')?.value || '1', 10) || 1);

      const cart = getCart();
      const existing = cart.find(x => x.id === itemId);

      if (existing) existing.qty += qty;
      else cart.push({ id:itemId, name, img, qty });

      setCart(cart);
      toast(`Added to cart (${qty})`);
    }

    /* =========================
       STRIPE FALLBACK (keeps your working checkout)
       ========================= */
    function getQty(){
      return Math.max(1, parseInt(document.getElementById('qty')?.value || '1', 10) || 1);
    }

    async function goStripeCheckout(priceId, quantity) {
      const r = await fetch('/api/create-checkout-session', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ items: [{ priceId, quantity }] })
      });
      const data = await r.json().catch(()=> ({}));
      const url = data.url || data.checkoutUrl || data.checkout_url;
      if (!r.ok || !url) throw new Error(data.error || ('Checkout failed ('+r.status+')'));
      window.location.href = url;
    }

    document.addEventListener('click', async (e) => {
      const btn = e.target.closest('[data-stripe-checkout]');
      if (!btn) return;

      e.preventDefault();
      e.stopImmediatePropagation();

      const priceId = btn.getAttribute('data-price-id') || '';
      if (!priceId) { alert('Missing Stripe price id.'); return; }

      try{
        btn.disabled = true;
        btn.setAttribute('aria-busy','true');
        await goStripeCheckout(priceId, getQty());
      }catch(err){
        console.error(err);
        alert(err?.message || 'Stripe checkout failed');
      }finally{
        btn.disabled = false;
        btn.removeAttribute('aria-busy');
      }
    }, true);

    /* =========================
       INIT
       ========================= */
    injectHeader();
    populate();

    // sync badge on load (and after header inject)
    document.addEventListener('DOMContentLoaded', () => {
      ensureCartBadge();
      updateCartBadge(getCartCount());
      document.getElementById('addToCart').addEventListener('click', addToCart);
    });
  </script>
</body>
</html>
